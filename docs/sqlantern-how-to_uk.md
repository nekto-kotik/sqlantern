# SQLantern: Поради та підказки (How-To)
Ліцензія: [GNU General Public License v3.0](LICENSE)

## Помилка `НЕ ВДАЛОСЬ З'ЄДНАТИСЬ` під час роботи із базою даних
Іноди при роботі в SQLantern Ви отримуватимете `Помилка [...] НЕ ВДАЛОСЬ З'ЄДНАТИСЬ` замість відповіді від серверу.\
Це нормально і очікувано. Ось що я рекомендую при цьому робити.

![](https://sqlantern.com/images/uk_connection_failed.png)

`НЕ ВДАЛОСЬ З'ЄДНАТИСЬ` означає, що _на сервері_ закінчилась PHP сесія, тобто сервер забув Ваші логін і пароль і більше не може з'єднатись із Вашою базою або базами даних. Треба знову відправити на сервер логін і пароль (кожний логін і пароль окремо, якщо у Вас багато одночасних з'єднань).\
(Технічно кажучи, якщо бути точним, сервер навіть не має паролів - вони зберігаються у браузері в зашифрованому вигляді, а сервер зберігає лише ключі шифрування, які генеруються випадковим чином для кожного з'єднання окремо.)

### Зробіть наступне, щоби перез'єднатись і продовжити працювати
- Нічого НЕ ЗАКРИВАЙТЕ і не оновлюйте сторінку. (_Можете_ це зробити, якщо _хочете_, але в цьому _немає необхідності_.)
- Додайте нову панель з'єднань - натисніть ![](https://sqlantern.com/images/icon_add_panel.png). Там не буде з'єднань, а буде форма із логіном і паролем.
- Введіть логін із паролем. З'єдайтесь.
- Закрийте цю нову щойно створену панель (яка вже перетворилась на панель із базами даних).
- Якщо Вам потрібно декілька з'єднань, повторіть ці кроки.
- Продовжуйте працювати. Можна і потрібно продовжувати працювати у вже відкритих панелях, наче нічого не сталось.

### Є два способи бачити `НЕ ВДАЛОСЬ З'ЄДНАТИСЬ` рідше
- Збільшіть значення `session.gc_maxlifetime` в налаштуваннях PHP. Це ймовірно зробить сервер менш захищеним, отже я _не раджу_ цього робити і не вдаватимусь в деталі. Цю зміну мають робити лише досвідчені професіонали.
- <del>Використовуйте функцію `Підтримувати це з'єднання` - натисніть ![](https://sqlantern.com/images/icon_keep_alive.png) в будь-якій панелі із таблицями. Це _зазвичай_ подовжує сесію на сервері (в PHP доволі складна логіка закінчення часу сесії), але не може повністю запобігти її закінченню (особливо якщо таб браузера із SQLantern _викинутий_ з пам'яті).</del> (Підтримка з'єднання тепер автоматично завжди ввімкнена.)

## Зберігайте робочий простір (все, що відкрито) і відновлюйте його пізніше
SQLantern дозволяє зберігати і відновлювати "сесії", тобто зберегти (і відновити) всі панелі і всі екрани в табі браузера, в якому Ви працюєте.\
Просто натисніть іконку "Сесії" - ![](https://sqlantern.com/images/icon_sessions.png) і оберіть дію (зберегти або відновити):\
![](https://sqlantern.com/images/uk_sessions.png)

Сесії зберігаються в браузері, в якому Ви працюєте, в `LocalStorage` браузера.\
Якщо "LocalStorage" буде випадково (або цілеспрямовано) видалено, всі Ваші сесії будуть втрачені (разом зі збереженими запитами, блокнотом і налаштуваннями).\
Ось способи зробити резервні копії "LocalStorage":

### Резервні копії даних SQLantern на Вашому комп'ютері (скачування LocalStorage SQLantern)
![](https://sqlantern.com/images/uk_back_up_to_client.png)

Перейдіть в Сесії / Бекапи і натисніть "Зберегти (скачати) бекап".\
Вам буде запропоновано зберегти на комп'ютері файл формату `json`.\
Цей файл буде містити: сесії, збережені запити, блокнот.\
**Увага**: Ці скачані файли містять _відкритий незашифрований текст у форматі JSON_. Будьте обережні і не дозволяйте їхнього ненавмисного витоку.

Щоби відновити резервну копію, скористайтесь зворотною функцією - `Відновити (завантажити) бекап`.

### Резервні копії даних SQLantern на сервері
Цей функціонал вимагає налаштування параметру `SQLANTERN_SERVER_SIDE_BACKUPS_ENABLED` в `true`.\
В ідеалі, бажано також встановити Ваше власне неочевидне значення `SQLANTERN_SERVER_SIDE_BACKUPS_FILE` (але Ви маєте хорошо розуміти, що туди вписати).

![](https://sqlantern.com/images/uk_back_up_to_server.png)

Перейдіть в Сесії / Бекапи, оберіть "На цьому сервері", введіть _складний пароль із високою ентропією_ і натисніть "Зберегти на сервері".\
Серверні резервні копії зберігаються в окремому файлі PHP, дані зашифровані і прийнятно захищені (використовуються bcrypt зі складністю 13 та AES-256-CBC із випадковими сіллю та ВІ).\
Пароль обов'язковий, але його якість не перевіряється і **лише Ви самі відповідальні, якщо резервну копію буде легко розшифрувати у випадку витоку** (по можливості використовуйте високоякісні унікальні паролі).

**Увага**: Різні паролі створять різні резервні копії. А використання _одного й того самого паролю зітре (перезапише) існуючу резервну копію_. Якщо декілька користувачів працюють в одному SQLantern і роблять резервні копії на сервері із однаковими паролями, вони перезапишуть резервні копії один одного.\
Підказка: Використовуючи різні паролі, Ви можете зберігати на сервері декілька різних резервних копій.

Щоби відновити резервну копію, скористайтесь зворотною функцією - `Відновити з серверу`.

<details>
	<summary>Інструкції з налаштування</summary>
	
Напишіть наступне в `php/config.sys.php`:
```
define("SQLANTERN_SERVER_SIDE_BACKUPS_ENABLED", true);
```
АБО це в `.htaccess`:
```
SetEnvIf Remote_Addr 254.254.254.254 SQLANTERN_SERVER_SIDE_BACKUPS_ENABLED="true"
# включити для однієї IP адреси - змініть 254.254.254.254 на свою статичну IP адресу
```
АБО це в `.htaccess`:
```
SetEnv SQLANTERN_SERVER_SIDE_BACKUPS_ENABLED "true"
# включити для всіх, не рекомендовано
```
</details>

## Як підключитись до інших хостів, аніж `localhost`
За замовчанням SQLantern під'єднується до `localhost` із ім'ям користувача, що вказане в полі "Логін". Якщо ви напишете "demo", він спробує з'єднатись із "localhost" як "demo" (що, до речі, не те ж саме, що "127.0.0.1").\
Щоби з'єднатись із іншим хостом, додайте "@" і після нього хост.\
(Для цього необхідно вмикнути `SQLANTERN_MULTIHOST`.)\
Наприклад, напишіть логін `trunk@one.one.one.one`, щоби з'єднатись із "one.one.one.one" як користувач "trunk".\
Замість хосту можна написати IP адресу.\
Наприклад, напишіть логін `branch@192.168.1.254`, щоби з'єднатись із "192.168.1.254" як користувач "branch".

Якщо Вам треба завжди з'єднуватись із одним і тим самим хостом, але не "localhost", раджу _не вмикати_ `SQLANTERN_MULTIHOST`, а змінити налаштування `SQLANTERN_DEFAULT_HOST`. Після цього також можна буде не вказувати хост в логіні.\
Наприклад, якщо встановити в `SQLANTERN_DEFAULT_HOST` значення "one.one.one.one" і після цього вказати логін "trunk" (без хосту), то SQLantern буде з'єднуватись із "one.one.one.one" як користувач "trunk".

<details>
	<summary>Інструкції з налаштування</summary>
	
Напишіть наступне в `php/config.sys.php`:
```
define("SQLANTERN_DEFAULT_HOST", "one.one.one.one");
// змініть one.one.one.one на бажаний хост або IP
define("SQLANTERN_MULTIHOST", true);
// глобальне вмикання `SQLANTERN_MULTIHOST` для всіх НЕ РЕКОМЕНДУЄТЬСЯ
```
АБО це в `.htaccess`:
```
SetEnvIf Remote_Addr 254.254.254.254 SQLANTERN_DEFAULT_HOST="one.one.one.one"
# змінити лише для однієї IP адреси - змінить 254.254.254.254 на Вашу статичну IP адресу
# змініть one.one.one.one на бажаний хост або IP
SetEnvIf Remote_Addr 254.254.254.254 SQLANTERN_MULTIHOST="true"
# вмикнути `SQLANTERN_MULTIHOST` для статичної IP адреси доволі безпечно
```
АБО це в `.htaccess`:
```
SetEnv SQLANTERN_DEFAULT_HOST "one.one.one.one"
# змінити значення для всіх
SetEnv SQLANTERN_MULTIHOST "true"
# вмикання `SQLANTERN_MULTIHOST` для всіх НЕ РЕКОМЕНДУЄТЬСЯ
```
</details>

## Як підключитись до PostgreSQL
В SQLantern порт визначає, який драйвер бази даних застосувати.\
За замовчанням налаштовані лише стандартні порти - `3306` для MariaDB/MySQL і `5432` для PostgreSQL.\
Тобто, якщо з'єднуватись через порт `3306`, то SQLantern застосує драйвер MariaDB/MySQL (PHP `mysqli`, якщо бути точним),  а якщо через порт `5432`, то SQLantern застосує драйвер PostgreSQL (PHP `pgsql`).

З урахуванням цього, щоби підключитись до PostgreSQL, Вам лише треба додати хост і порт в логін.\
Наприклад, логін `demo@192.168.1.254:5432` з'єднається із хостом "192.168.1.254" як користувач "demo", використовуючи драйвер PostgreSQL.\
(До речі, якщо треба написати порт, то прописувати хост також необхідно, навіть якщо це `localhost`.)

Якщо Ви хочете _завжди_ підключатись до PostgreSQL і не прописувати порт в логіні (підключатись до PostgreSQL за замовчанням), встановіть значення "5432" в налаштуванні `SQLANTERN_DEFAULT_PORT`.

<details>
	<summary>Встановити порт 5432 за замовчанням</summary>

Напишіть наступне в `php/config.sys.php`:
```
define("SQLANTERN_DEFAULT_PORT", "5432");
```
АБО це в `.htaccess`:
```
SetEnv SQLANTERN_DEFAULT_PORT "5432"
```
</details>

База даних для підключення - "postgres" (її вимагає PostgreSQL).\
Якщо Вам це не підходить, встановіть потрібне значення в `SQLANTERN_POSTGRES_CONNECTION_DATABASE`. Якщо Ви не знаєте, про що мова, то скоріше за все Вам не треба цього змінювати :-)\
(Ви маєте самі знати, що працює у Вашому випадку, я не можу порадити, це індивідуально.)

<details>
	<summary>Інструкції з налаштування</summary>

Напишіть наступне в `php/config.sys.php`:
```
define("SQLANTERN_POSTGRES_CONNECTION_DATABASE", "template1");
// не забудьте змінити "template1" на потрібне значення
```
АБО це в `.htaccess`:
```
SetEnv SQLANTERN_POSTGRES_CONNECTION_DATABASE "template1"
# не забудьте змінити "template1" на потрібне значення
```
</details>

Якщо Вам треба підключатись через нестандарті порти, дивіться розділ "Як підключатись через нестандартні порти" в цьому документі.

## Як підключатись через нестандартні порти
Додайте налаштування `SQLANTERN_PORT_{number}`, щоби підключатись через порт `{number}`.\
_Значення_ має бути одним із драйверів SQLantern: `mysqli` або `pgsql`.\
Наприклад, напишіть `SQLANTERN_PORT_13306` зі значенням `mysqli`, щоби з'єднуватись із MariaDB/MySQL через порт 13306.\
Або, наприклад, напишіть `SQLANTERN_PORT_54320` зі значенням `pgsql`, щоби з'єднуватись із PostgreSQL через порт 54320.

Кожний порт вимагає окремого налаштування. Пишіть стільки цих налаштувань, скільки Вам потрібно.

За замовчанням налаштовані порти 3306 та 5432 (`SQLANTERN_PORT_3306` має значення `mysqli`, а `SQLANTERN_PORT_5432` має значення `pgsql`).

<details>
	<summary>Інструкції з налаштування</summary>

Напишіть наступне в `php/config.sys.php`:
```
define("SQLANTERN_PORT_13306", "mysqli");
// змініть 13306 на потрібний порт; значення може бути "mysqli" або "pgsql"
```
АБО це в `.htaccess`:
```
SetEnv SQLANTERN_PORT_13306 "mysqli"
# змініть 13306 на потрібний порт; значення може бути "mysqli" або "pgsql"
```
</details>

## Захист однофайлової версії SQLantern
Однофайлова версія SQLantern зроблена так, щоби її можна було просто скопіювати і вона одразу працювала. Однак, варто зробити декілька простих кроків для її захисту.\
Ось що особисто я завжди роблю із однофайловою версію і раджу робити всім іншим:
- Ніколи не кладу SQLantern в корінь сайту. Зазвичай, я створюю шлях на кшталт `/.secret/.not-sqlantern` і кладу файл туди :-) В ідеалі, Ви маєте вигадати свій власний таємний шлях.
- Дозволяю доступ до цієї таємної директорії лише з моєї статичної IP адреси за допомогою `.htaccess`:
	```
	Order Deny,Allow
	Allow from 254.254.254.254
	Deny from all
	# змініть 254.254.254.254 на Вашу статичну IP адресу
	```
- Перейменовую файл - він працює під будь-яким іменем. Як правило, я кладу його в таємну директорію і перейменовую на `index.php` (бо я все одно захищаю всю директорію).

Якщо у Вас немає статичної IP адреси, я раджу хоча б класти SQLantern в таємну директорію і/або перейменувати його у щось випадкове і не очевидне.\
Якщо у Вас немає статичної IP адреси, але є можливість захистити директорію із SQLantern паролем, це також дуже рекомендується. (Шукайте функцію захисту паролем в Вашій панелі керування сервером, зазвичай для цього є користувацький інтерфейс.)

## Як налаштувати однофайлову версію (кастомні серверні налаштування однофайлової версії SQLantern)
Буває потреба використовувати однофайлову версію із нестандартними налаштуваннями:
- з'єднуватись із багатьма хостами
- з'єднуватись із одним хостом, але не `localhost`
- з'єднуватись через нестандартні порти
- і т.і.

Але однофайлова версія не читає `config.sys.php`.\
_Однак, вона читає змінні середовища (environment variables)_ і все може бути налаштовано через них (починаючи з версії 1.9.13).\
Ось декілька прикладів налаштування в `.htaccess`:
```
# якщо треба з'єднуватись лише із одним хостом, але це не `localhost`, встановіть `SQLANTERN_DEFAULT_HOST`
# (змініть "one.one.one.one" на потрібний хост або IP)
SetEnv SQLANTERN_DEFAULT_HOST "one.one.one.one"
# якщо треба з'єднуватись із багатьма хостами, встановіть `SQLANTERN_MULTIHOST` в true - будь ласка, будьте відповідальні і обережні із цим
SetEnv SQLANTERN_MULTIHOST "true"
# нестандартні порти
SetEnv SQLANTERN_PORT_33060 "mysqli"
SetEnv SQLANTERN_PORT_55432 "pgsql"
# з'єднуватись із MariaDB/MySQL із SSL
SetEnv SQLANTERN_USE_SSL "true"
```

У цей спосіб можна налаштувати _все_, можливо навіть вмикнути `SQLANTERN_SERVER_SIDE_BACKUPS_ENABLED` і зберігати резервні копії на сервері в однофайловому SQLantern.

Будьте обережні і завжди захищайте однофайлову версію, будь ласка (як описано в окремій секції цього файлу).

## З'єднання із SSL
Коли потрібно з'єднатись із сервером із SSL, встановіть серверне налаштування `SQLANTERN_USE_SSL` в `true`.

<details>
	<summary>Інструкції з налаштування</summary>

Напишіть наступне в `php/config.sys.php`:
```
define("SQLANTERN_USE_SSL", "true");
```
АБО це в `.htaccess`:
```
SetEnv SQLANTERN_USE_SSL "true"
```
</details>

Часто немає можливості додати сертифікат SSL на сервер із SQLantern.\
Щоби обійти це, існує можливість **відключити перевірку SSL** (довіряти сертифікату наосліп, без перевірки).\
Якщо Ви цього бажаєте, встановіть налаштування `SQLANTERN_TRUST_SSL` в `true`.\
**Це не рекомендується і цього ніколи не варто робити, окрім як для тестування і дебагу.**

<details>
	<summary>Інструкції з налаштування</summary>

Напишіть наступне в `php/config.sys.php`:
```
define("SQLANTERN_TRUST_SSL", "true");
```
АБО це в `.htaccess`:
```
SetEnv SQLANTERN_TRUST_SSL "true"
```
</details>

Обидва ці налаштування працюють **лише** в MariaDB/MySQL.

## Виведення справжньої помилки замість шаблонної "НЕ ВДАЛОСЬ З'ЄДНАТИСЬ"
За замовчанням SQLantern повертає лише помилку "НЕ ВДАЛОСЬ З'ЄДНАТИСЬ" без уточнень. Це робиться, щоби заплутати зловмисників.\
Зазвичай правомірним користувачам не потрібно знати справжню причину помилки з'єднання, але іноді це необхідно.\
Якщо Вам потрібно побачити справжню помилку з'єднання, встановіть налаштування `SQLANTERN_SHOW_CONNECTION_ERROR` в `true`.

![](https://sqlantern.com/images/uk_real_connection_error.png)

<details>
	<summary>Інструкції з налаштування</summary>

Напишіть наступне в `php/config.sys.php`:
```
define("SQLANTERN_SHOW_CONNECTION_ERROR", true);
// вмикнути для всіх, не рекомендується
```
АБО це в `.htaccess`:
```
SetEnvIf Remote_Addr 254.254.254.254 SQLANTERN_SHOW_CONNECTION_ERROR=true
# вмикнути лише для однієї IP адреси - змініть 254.254.254.254 на Вашу статичну IP адресу
```
АБО це в `.htaccess`:
```
SetEnv SQLANTERN_SHOW_CONNECTION_ERROR "true"
# вмикнути для всіх, не рекомендується
```
Вмикаючи `SQLANTERN_SHOW_CONNECTION_ERROR`, переконайтесь, що Ваша копія SQLantern захищена додатковими методами (наприклад, фільтр за IP або захищена паролем директорія) і зловмисні користувачі певно заблоковані.
</details>

## При імпортуванні бази даних Ви отримуєте "Server has gone away" (або "Server not responding")
Функціонал імпорту баз даних в SQLantern зроблений дуже компромісно.\
Він займає більше часу аніж у інших менеджерах і використовує _неадекватний_ об'єм оперативної пам'яті серверу. Це відбувається не за моєю провиною і не піддається контролю, це наслідок якоїсь внутрішньої взаємодії між PHP і драйвером `mysqli`.\
Єдина відома мені причина помилки "Server has gone away": в процесі імпорту на сервері повністю закінчилась вся вільна оперативна пам'ять (точніше, вся пам'ять і swap).\
Якщо у Вас працює імпорт - чудово.\
Якщо ні - мені шкода.\
Вирішення у мене, на жаль, немає, і навряд чи буде.
